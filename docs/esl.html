

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Electronic Shelf Label Service (ESLS) &mdash; ESL  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/nordic.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/nordic.css" type="text/css" />
  <link rel="stylesheet" href="_static/tabs.css" type="text/css" />

  
  

  
  

  

  
  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
  <script type="text/javascript" src="_static/js/ncs.js"></script>

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <link rel="shortcut icon" href="_static/images/favicon.ico"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> ESL
          

          
          </a>

          
            
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Subpages:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="environment_setup.html">Requirements and setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="samples.html">Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional_resources.html">Additional resources</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ESL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Electronic Shelf Label Service (ESLS)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/esl.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="electronic-shelf-label-service-esls">
<span id="esl-service-readme"></span><h1>Electronic Shelf Label Service (ESLS)<a class="headerlink" href="#electronic-shelf-label-service-esls" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#configuration" id="id10">Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#leds-configuration" id="id11">LEDs configuration</a></p></li>
<li><p><a class="reference internal" href="#displays-configuration" id="id12">Displays configuration</a></p></li>
<li><p><a class="reference internal" href="#sensors-configuration" id="id13">Sensors configuration</a></p></li>
<li><p><a class="reference internal" href="#optional-configuration" id="id14">Optional configuration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#usage" id="id15">Usage</a></p></li>
<li><p><a class="reference internal" href="#callbacks" id="id16">Callbacks</a></p>
<ul>
<li><p><a class="reference internal" href="#led-callbacks" id="id17">LED Callbacks</a></p></li>
<li><p><a class="reference internal" href="#display-callbacks" id="id18">Display Callbacks</a></p></li>
<li><p><a class="reference internal" href="#sensor-callbacks" id="id19">Sensor Callbacks</a></p></li>
<li><p><a class="reference internal" href="#image-storage-callback" id="id20">Image storage Callback</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-documentation" id="id21">API documentation</a></p></li>
</ul>
</div>
<p>The Electronic Shelf Label Service allows electronic shelf labels (ESL) to be controlled and updated using Bluetooth® wireless technology.
The purpose of an ESL (Electronic Shelf Label) service is to enable communication and control between a central access point (AP) and lot of ESL Tag devices.
This service implements complete of ESL state machine and ESL Control Point command handler.
The actual HW control leaves to the application as callback functions and the application must implement all of callback functions.
The ESL Service is used in the <a class="reference internal" href="esl_tag.html#peripheral-esl"><span class="std std-ref">Bluetooth: Peripheral ESL</span></a> sample.</p>
<section id="configuration">
<span id="esls-config"></span><h2><a class="toc-backref" href="#id10">Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>An ESL is composed of certain elements. Three types of independent, optional elements (a display, a light-emitting diode (LED), and a sensor).
First thing first is to configure hardware information of the ESL Tag. Three elements need to be set.</p>
<section id="leds-configuration">
<span id="esls-config-led"></span><h3><a class="toc-backref" href="#id11">LEDs configuration</a><a class="headerlink" href="#leds-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_LED_MAX</span></code> is the maximum number of LEDs that are on ESL Tag. The default value is 0 which means there is no LED on ESL Tag.
If there is LED on ESL Tag, the application must implement the callback function <code class="xref c c-func docutils literal notranslate"><span class="pre">led_init()</span></code>, <code class="xref c c-func docutils literal notranslate"><span class="pre">led_control`()</span></code> to control the LED.
ESL Service will generate LED information in GATT characteristic and LED work item in the work queue.
When ESL Service is asked to control LED, it will call the callback function to control the LED.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_LED_INDICATION</span></code> is an option for debugging. If this option is enabled, the LED will be turned on or flashing when the Tag is in the corresponding state.</p>
</section>
<section id="displays-configuration">
<span id="esls-config-display"></span><h3><a class="toc-backref" href="#id12">Displays configuration</a><a class="headerlink" href="#displays-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_DISPLAY_MAX</span></code> is the maximum number of displays that are on ESL Tag. The default value is 0 which means there is no display on ESL Tag.
If there is display on ESL Tag, the application must implement the callback function <code class="xref c c-func docutils literal notranslate"><span class="pre">display_init()</span></code> <code class="xref c c-func docutils literal notranslate"><span class="pre">display_control()</span></code> to control the display.
ESL Service will generate display information in GATT characteristic and display work item in the work queue.
When ESL Service is asked to control display, it will call the callback function to control the display.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_DISPLAY_WIDTH</span></code> and <code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_DISPLAY_HEIGHT</span></code> are resolution of display device of ESL Tag. These value could be accquired by device tree if ESL Tag uses display with Zephyr driver. However, for some ESL Tag uses its own driver. These values need to be config explicitly.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_DISPLAY_TYPE</span></code> is display type which is defined by Bluetooth SIG assigned number.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_IMAGE_FILE_SIZE</span></code> is the file size reserved for OTS(Object Transfer Service) storage backend. It is generally the width x height x bit depth plus image header.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_IMAGE_BUFFER_SIZE</span></code> is the memory reserved for display framebuffer. It is generally the width x height x bit depth plus image header size. This memory size could be smaller than image file for some display IC and storage backend.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_IMAGE_MAX</span></code> is how many images could be stored in ESL Tag. To choose this values need to trade-off power consumpation and non-volatile size. Image stored in non-volatile memory of ESL Tag. The more images could be stored the less chance ESL Tag need to be in updateing state to receive new image. The less images could be stored the less non-volatile memory is required by ESL Tag.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_STORAGE_BACKEND</span></code> choose storage backend to store image from AP. <code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_OTS_NVS</span></code> NVS is a lightweight key-value store that is optimized for small data reads and writes. But does not support seek feature. <code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_OTS_LFS</span></code> LittleFS is a full-featured filesystem that is optimized for larger data reads and writes. But supports seek feature.
The choice between the two depends on the specific requirements of your application and the hardware (MCU, external flash or not) you are using.</p>
</section>
<section id="sensors-configuration">
<span id="esls-config-sensor"></span><h3><a class="toc-backref" href="#id13">Sensors configuration</a><a class="headerlink" href="#sensors-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_SENSOR_MAX</span></code> is the maximum number of displays that are on ESL Tag. The default value is 0 which means there is no sensor on ESL Tag.
If there is display on ESL Tag, the application must implement the callback function <code class="xref c c-func docutils literal notranslate"><span class="pre">sensor_init()</span></code> <code class="xref c c-func docutils literal notranslate"><span class="pre">sensor_control()</span></code> to read the sensor.</p>
</section>
<section id="optional-configuration">
<span id="esls-config-optionals"></span><h3><a class="toc-backref" href="#id14">Optional configuration</a><a class="headerlink" href="#optional-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_ESL_SHELL</span></code> is an option for debugging. If this option is enabled, the shell command will be available to control the ESL Tag.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_DEMO_SECURITY</span></code> is an option for debugging. If this option is enabled, the bonding data will be removed after disconnected.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_FORGET_PROVISION_DATA</span></code> is an option for debugging. If this option is enabled, the provisioning data will be removed after disconnected.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_UNSYNCHRONIZED_TIMEOUT</span></code> is the option for debugging. Change this value to override mandatory 60 minutes unsynchronized timeout value defined by Bluetooth SIG.</p>
<p><code class="xref std std-option docutils literal notranslate"><span class="pre">CONFIG_BT_ESL_UNASSOCIATED_TIMEOUT</span></code> is the option for debugging. Change this value to override mandatory 60 minutes unassociated timeout value defined by Bluetooth SIG.</p>
</section>
</section>
<section id="usage">
<span id="esls-usage"></span><h2><a class="toc-backref" href="#id15">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To use ESLS in your application, follow these instructions:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#esls-config"><span class="std std-ref">Configuration</span></a> Kconfig according to your hardware.</p></li>
<li><p>Declare <code class="xref c c-struct docutils literal notranslate"><span class="pre">bt_esl_init_param</span></code>, fill in element <code class="xref c c-struct docutils literal notranslate"><span class="pre">esl_disp_inf</span></code> Display, <code class="xref c c-struct docutils literal notranslate"><span class="pre">esl_sensor_inf</span></code> Sensor, <code class="xref c c-struct docutils literal notranslate"><span class="pre">led_type</span></code> LED information to member of <code class="xref c c-struct docutils literal notranslate"><span class="pre">bt_esl_init_param</span></code></p></li>
<li><p>Implement all of callback functions required</p></li>
<li><p>Implement <code class="xref c c-func docutils literal notranslate"><span class="pre">ots_storage_init()</span></code></p></li>
<li><p>Call the <code class="xref c c-func docutils literal notranslate"><span class="pre">bt_esl_init()</span></code> function</p></li>
</ul>
</div></blockquote>
</section>
<section id="callbacks">
<span id="esls-callbacks"></span><h2><a class="toc-backref" href="#id16">Callbacks</a><a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h2>
<p>ESL service requires some callback functions to control the hardware. The application must implement callback functions regarding which hardware are on ESL Tag.
To implement the ESL Tag functionality, several callback functions are needed. These callbacks are used to control the display, LED, and sensor devices, as well as to buffer and write image data to storage. In this section, we will explain why these callbacks are needed and how to implement them.</p>
<section id="led-callbacks">
<span id="esls-cb-led"></span><h3><a class="toc-backref" href="#id17">LED Callbacks</a><a class="headerlink" href="#led-callbacks" title="Permalink to this headline">¶</a></h3>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">led_init()</span></code> callback is used to initialize the LED device. To implement this callback, you need to write a function that initializes the LED device.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">led_control()</span></code> callback is used to change the LED state e.g.: on / off, brightness, color (if SRGB LED used). This function is called when the ESL Tag decides to change the LED flashing pattern. The function takes three arguments: the index of the LED, the color and brightness to be controlled, and a boolean value indicating whether to turn on or off the LED. To implement this callback, you need to write a function that takes these arguments and performs the necessary operations to change the LED state.</p>
</section>
<section id="display-callbacks">
<span id="esls-cb-display"></span><h3><a class="toc-backref" href="#id18">Display Callbacks</a><a class="headerlink" href="#display-callbacks" title="Permalink to this headline">¶</a></h3>
<p>You need to implement the following callbacks to if display device exists on ESL Tag.
The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_init()</span></code> callback is used to initialize the display device if additional work is not done by display driver. e.g.: Initialize memory region for framebuffer, set font type. To implement this callback, you need to write a function that initializes the display device.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_control()</span></code> callback is used to change the image displayed on the ESL Tag. This function is called when the ESL Tag decides to change the image. The function takes three arguments: the index of the display device, the index of the image, and a boolean value indicating whether to turn on or off the display. To implement this callback, you need to write a function that takes these arguments and performs the necessary operations to change the image on the display device.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_unassociated()</span></code> callback is used to show information on the display device to help the user inspect ESL Tag to be associated. This function is called when the ESL Tag is booting up and unassociated. To implement this callback, you need to write a function that takes the index of the display device and displays the necessary information on the device.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_associated()</span></code> callback is used to show information on the display device to indicate that the ESL Tag has been associated. This function is called when the ESL Tag is booting up and associated but not synced or not commanded to display an image. To implement this callback, you need to write a function that takes the index of the display device and displays the necessary information on the device.</p>
<p>These are optional callbacks for font library. If you want to use font library to print text on the display device, you need to implement these callbacks.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_clear_font()</span></code> callback is used to clear the framebuffer allocated by the font library for the specified display. This function is a callback for the font library and clears the framebuffer allocated by the font library for the specified display. The function disables all images on the display by clearing the framebuffer. To implement this callback, you need to write a function that takes the index of the display device and clears the framebuffer.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">display_print_font()</span></code> callback is used to print text on the specified display using the font library. This function is a callback for the font library and prints text on the specified display using the font library. The text is printed at the specified position with the specified font. To implement this callback, you need to write a function that takes the index of the display device, the text to print, and the position to print the text. This callback should only change framebuffer and not update the display. The display will be updated by the <cite>display_update_font</cite> callback.</p>
<p>The <a href="#id1"><span class="problematic" id="id2">:cfunc:`display_update_font`</span></a> callback is used to finalize the CFB or font libarry and check if the EPD (Electronic Paper Display) needs to be re-initialized. This function update display by flushing any pending updates to the display buffer and checking if the EPD needs to be re-initialized. To implement this callback, you need to write a function that takes the index of the display device and write font framebuffer to display.</p>
</section>
<section id="sensor-callbacks">
<span id="id3"></span><h3><a class="toc-backref" href="#id19">Sensor Callbacks</a><a class="headerlink" href="#sensor-callbacks" title="Permalink to this headline">¶</a></h3>
<p>You need to implement the following callbacks to if sensor device exists on ESL Tag.
The <code class="xref c c-func docutils literal notranslate"><span class="pre">sensor_init()</span></code> callback is used to initialize the sensor device. To implement this callback, you need to write a function that initializes the sensor device.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">sensor_control()</span></code> callback is used to read sensor data when the ESL Tag decides to do so. This function takes two output arguments: the length of the sensor data and a pointer to the sensor data reading. To implement this callback, you need to write a function that takes the index of the sensor and stores the sensor data to <code class="xref c c-struct docutils literal notranslate"><span class="pre">sensor_data</span></code>. If the sensor reading is successful, return 0. If the sensor reading is not fast enough or fails, return <code class="xref c c-enumerator docutils literal notranslate"><span class="pre">-EBUSY</span></code>. The ESL service will generate a response based on the return value of this function.</p>
</section>
<section id="image-storage-callback">
<span id="esls-cb-image-storage"></span><h3><a class="toc-backref" href="#id20">Image storage Callback</a><a class="headerlink" href="#image-storage-callback" title="Permalink to this headline">¶</a></h3>
<p>The ESL Tag with a display device requires several callbacks to be implemented. One of the mandatory features of these tags is to receive and store image data from the AP through OTS (Object Transfer Service), and to read image data to the framebuffer from storage when the tag decides to change the image on the display.
You need to implement the following callbacks to if display device exists on ESL Tag. The implementation varies depending on the storage backend. The storage backend can be NVS or LittleFS.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">buffer_img()</span></code> callback is used to buffer image data from AP when OTS (Object Transfer Service) write operation callback called. Image data from OTS may come in fragments, and some filesystems support seek while others do not. This callback should either buffer all fragments into <code class="xref c c-member docutils literal notranslate"><span class="pre">img_obj_buf</span></code> and writes them once for storage backend not support seek feature. Or write chunck to chunk for storage backend supports seek feature.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">write_img_to_storage()</span></code> callback is used to write image data to the storage backend when chunk of image or all of the fragments from OTS are received. To implement this callback, you need to write a function that takes the image index, length, and offset and writes the image data to the storage backend.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">read_img_from_storage()</span></code> callback is used to read image data from the storage backend to framebuffer when the ESL Tag decides to change the image on the display. To implement this callback, you need to write a function that takes the image index, data pointer, length, and offset and reads the image data from the storage backend.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For storage backend supports seek feature and display driver IC supports partial update, the usage of:c:func:<cite>read_img_from_storage</cite> callback could only read the changed part of the image from the storage backend to the framebuffer. The display driver IC will only update the changed part of the image on the display.
For storage backend doesn’t support seek feature, the usage of <code class="xref c c-func docutils literal notranslate"><span class="pre">read_img_from_storage()</span></code> callback could only read the whole image from the storage backend to the framebuffer. The display driver IC will update the whole image on the display.</p>
</div>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">read_img_size_from_storage()</span></code> callback is used to read the image size from the storage backend when the ESL Tag decides to change the image on the display. To implement this callback, you need to write a function that takes the image index and returns the image size.</p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">delete_imgs()</span></code> callback is used to remove all images from the storage backend when received factory reset op code. To implement this callback, you need to write a function that removes all images from the storage backend.</p>
</section>
</section>
<section id="api-documentation">
<h2><a class="toc-backref" href="#id21">API documentation</a><a class="headerlink" href="#api-documentation" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Header file: <code class="file docutils literal notranslate"><span class="pre">services/esl.h</span></code></div>
<div class="line">Source files: <code class="file docutils literal notranslate"><span class="pre">services/esl.c</span></code></div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2023, Nordic Semiconductor.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="_static/images/nordic.svg" border="0"/></a>
</td>
</tr>
</table>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>